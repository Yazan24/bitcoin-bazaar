<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="بتكوين.بازار - السوق العربي اللامركزي للتجارة الآمنة بالبيتكوين والبرق. Arabic Bitcoin marketplace with Lightning Network payments.">
    <meta name="keywords" content="bitcoin, lightning network, arabic marketplace, cryptocurrency, بتكوين, سوق عربي, تجارة إلكترونية">
    <meta name="author" content="Bitcoin Bazaar Team">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="بتكوين.بازار - Arabic Bitcoin Marketplace">
    <meta property="og:description" content="Decentralized Arabic marketplace powered by Bitcoin and Lightning Network">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://yazan24.github.io/bitcoin-bazaar/">
    <meta property="og:image" content="https://yazan24.github.io/bitcoin-bazaar/assets/og-image.png">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="بتكوين.بازار - Arabic Bitcoin Marketplace">
    <meta name="twitter:description" content="Decentralized Arabic marketplace powered by Bitcoin and Lightning Network">
    <meta name="twitter:image" content="https://yazan24.github.io/bitcoin-bazaar/assets/og-image.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>₿</text></svg>">
    
    <!-- Preconnect to external resources -->
    <link rel="preconnect" href="https://api.coingecko.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    
    <!-- Critical CSS inlined -->
    <style>
        :root {
            --primary-color: #f7941d;
            --secondary-color: #667eea;
            --accent-color: #764ba2;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --bg-glass: rgba(255, 255, 255, 0.1);
            --bg-card: rgba(255, 255, 255, 0.9);
            --border-glass: rgba(255, 255, 255, 0.2);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Cairo', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--accent-color) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--accent-color) 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }

        .loading-content {
            text-align: center;
            color: white;
        }

        .loading-logo {
            font-size: 4rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        .loading-text {
            font-size: 1.2rem;
            margin-bottom: 30px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        /* Header Styles */
        .header {
            text-align: center;
            margin-bottom: 40px;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid var(--border-glass);
            animation: slideInDown 1s ease-out;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(247, 148, 29, 0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        .header > * {
            position: relative;
            z-index: 1;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .logo {
            font-size: clamp(2rem, 5vw, 3rem);
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            transition: transform 0.3s ease;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .tagline {
            font-size: clamp(1rem, 2.5vw, 1.2rem);
            color: white;
            margin-bottom: 20px;
            opacity: 0.9;
        }

        .lightning-icon {
            display: inline-block;
            animation: lightning-pulse 2s infinite;
            margin: 0 10px;
            color: #ffd700;
        }

        @keyframes lightning-pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        /* Search Bar */
        .search-bar {
            width: 100%;
            max-width: 500px;
            margin: 20px auto;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 15px 50px 15px 20px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        .search-input:focus {
            outline: none;
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .search-btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary-color);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-btn:hover {
            background: #e6820a;
            transform: translateY(-50%) scale(1.1);
        }

        /* Status Indicators */
        .status-indicators {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .status-item {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-item:hover {
            transform: translateX(5px);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-color);
            animation: pulse 2s infinite;
        }

        /* Stats Grid */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 1px solid var(--border-glass);
            transition: all 0.3s ease;
            animation: slideInUp 1s ease-out;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.8s;
        }

        .stat-card:hover::before {
            left: 100%;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-xl);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 10px;
            transition: color 0.3s ease;
        }

        .stat-card:hover .stat-number {
            color: var(--primary-color);
        }

        .stat-label {
            color: white;
            font-size: 1rem;
        }

        /* Marketplace Section */
        .marketplace-section {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid var(--border-glass);
            animation: slideInRight 1s ease-out;
        }

        .section-title {
            font-size: 1.8rem;
            color: white;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 3px;
            background: var(--primary-color);
            border-radius: 2px;
        }

        /* Stalls Grid */
        .stalls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .stall-card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .stall-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(247, 148, 29, 0.1), transparent);
            transition: left 0.5s;
        }

        .stall-card:hover::before {
            left: 100%;
        }

        .stall-card:hover {
            transform: translateY(-10px);
            box-shadow: var(--shadow-xl);
        }

        .stall-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stall-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--text-primary);
        }

        .stall-rating {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: var(--text-primary);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            box-shadow: var(--shadow-sm);
        }

        .stall-description {
            color: var(--text-secondary);
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .stall-products {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(247, 148, 29, 0.1);
            border-radius: 8px;
        }

        .stall-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.9rem;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary-color), #ffd700);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: linear-gradient(45deg, var(--secondary-color), var(--accent-color));
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Features Grid */
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .feature-card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 1px solid var(--border-glass);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(247, 148, 29, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .feature-card:hover::before {
            opacity: 1;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-xl);
        }

        .feature-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            transition: transform 0.3s ease;
        }

        .feature-card:hover .feature-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .feature-title {
            font-size: 1.2rem;
            color: white;
            margin-bottom: 10px;
            font-weight: bold;
            position: relative;
            z-index: 1;
        }

        .feature-description {
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.5;
            position: relative;
            z-index: 1;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
            box-shadow: var(--shadow-xl);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .close {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }

        .close:hover {
            color: var(--error-color);
        }

        /* Product Grid */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .product-card {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .product-card:hover {
            transform: scale(1.05);
            border-color: var(--primary-color);
            box-shadow: var(--shadow-lg);
        }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 50px;
            padding: 30px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            color: white;
            border: 1px solid var(--border-glass);
        }

        .footer h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .footer p {
            margin-bottom: 20px;
            opacity: 0.9;
        }

        /* Animations */
        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header {
                padding: 20px;
            }

            .stalls-grid {
                grid-template-columns: 1fr;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .features {
                grid-template-columns: 1fr;
            }

            .status-indicators {
                position: relative;
                top: auto;
                left: auto;
                margin-bottom: 20px;
                flex-direction: row;
                justify-content: center;
                flex-wrap: wrap;
            }

            .modal-content {
                width: 95%;
                margin: 5% auto;
                padding: 20px;
            }

            .stall-actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .stats {
                grid-template-columns: 1fr;
            }

            .logo {
                font-size: 2rem;
            }

            .tagline {
                font-size: 1rem;
            }

            .section-title {
                font-size: 1.5rem;
            }
        }

        /* Performance optimizations */
        .stall-card, .feature-card, .stat-card {
            will-change: transform;
        }

        /* Print styles */
        @media print {
            .status-indicators,
            .loading-screen {
                display: none !important;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
            
            .header,
            .marketplace-section,
            .footer {
                background: white !important;
                color: black !important;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --bg-glass: rgba(255, 255, 255, 0.9);
                --bg-card: rgba(255, 255, 255, 1);
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-card: rgba(30, 30, 30, 0.9);
                --text-primary: #f9fafb;
                --text-secondary: #d1d5db;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-content">
            <div class="loading-logo">₿</div>
            <div class="loading-text">جاري تحميل بتكوين.بازار<br>Loading Bitcoin Bazaar...</div>
            <div class="loading-spinner"></div>
        </div>
    </div>

    <!-- Status Indicators -->
    <div class="status-indicators">
        <div class="status-item" id="btcPrice">
            <div class="status-dot"></div>
            <span>₿ $67,420</span>
        </div>
        <div class="status-item" id="networkStatus">
            <div class="status-dot"></div>
            <span>متصل</span>
        </div>
        <div class="status-item" id="lightningStatus">
            <div class="status-dot"></div>
            <span>⚡ البرق نشط</span>
        </div>
    </div>

    <div class="container">
        <header class="header">
            <h1 class="logo">₿ بتكوين.بازار</h1>
            <p class="tagline">
                السوق العربي اللامركزي للتجارة الآمنة بالبيتكوين
                <span class="lightning-icon">⚡</span>
                Decentralized Arabic Bitcoin Marketplace
            </p>
            <div class="search-bar">
                <input 
                    type="text" 
                    class="search-input" 
                    placeholder="ابحث عن المنتجات... Search products..."
                    aria-label="Search products"
                >
                <button class="search-btn" aria-label="Search">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M21.71 20.29L18 16.61A9 9 0 1 0 16.61 18l3.68 3.68a1 1 0 0 0 1.42 0 1 1 0 0 0 0-1.39zM11 18a7 7 0 1 1 7-7 7 7 0 0 1-7 7z"/>
                    </svg>
                </button>
            </div>
        </header>

        <section class="stats" role="region" aria-label="Marketplace Statistics">
            <div class="stat-card">
                <div class="stat-number" data-target="1234">0</div>
                <div class="stat-label">متاجر نشطة<br>Active Stalls</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" data-target="5678">0</div>
                <div class="stat-label">منتجات متاحة<br>Available Products</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" data-target="98.5">0</div>
                <div class="stat-label">نسبة الأمان<br>Safety Rating %</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">24/7</div>
                <div class="stat-label">متاح دائماً<br>Always Available</div>
            </div>
        </section>

        <section class="marketplace-section">
            <h2 class="section-title">المتاجر المميزة - Featured Stalls</h2>
            <div class="stalls-grid">
                <article class="stall-card" onclick="openStall('dubai-electronics')" role="button" tabindex="0">
                    <header class="stall-header">
                        <h3 class="stall-name">متجر دبي للإلكترونيات</h3>
                        <div class="stall-rating" aria-label="Rating 4.9 out of 5">⭐ ٤.٩</div>
                    </header>
                    <p class="stall-description">
                        أحدث الأجهزة الإلكترونية والهواتف الذكية بأفضل الأسعار
                        <br><small>Latest electronics and smartphones at best prices</small>
                    </p>
                    <div class="stall-products">📱 هواتف • 💻 أجهزة كمبيوتر • 🎧 سماعات</div>
                    <div class="stall-actions">
                        <button class="btn btn-primary">تصفح المنتجات</button>
                        <button class="btn btn-secondary">تواصل معنا</button>
                    </div>
                </article>

                <article class="stall-card" onclick="openStall('cairo-books')" role="button" tabindex="0">
                    <header class="stall-header">
                        <h3 class="stall-name">مكتبة القاهرة الرقمية</h3>
                        <div class="stall-rating" aria-label="Rating 4.8 out of 5">⭐ ٤.٨</div>
                    </header>
                    <p class="stall-description">
                        كتب ومراجع تقنية وأدبية باللغتين العربية والإنجليزية
                        <br><small>Technical and literary books in Arabic and English</small>
                    </p>
                    <div class="stall-products">📚 كتب تقنية • 📖 أدب • 🎓 مراجع أكاديمية</div>
                    <div class="stall-actions">
                        <button class="btn btn-primary">تصفح المكتبة</button>
                        <button class="btn btn-secondary">طلب كتاب</button>
                    </div>
                </article>

                <article class="stall-card" onclick="openStall('beirut-fashion')" role="button" tabindex="0">
                    <header class="stall-header">
                        <h3 class="stall-name">بوتيك بيروت للأزياء</h3>
                        <div class="stall-rating" aria-label="Rating 4.7 out of 5">⭐ ٤.٧</div>
                    </header>
                    <p class="stall-description">
                        أزياء عصرية وتقليدية للرجال والنساء بجودة عالية
                        <br><small>Modern and traditional fashion for men and women</small>
                    </p>
                    <div class="stall-products">👗 أزياء نسائية • 👔 أزياء رجالية • 👜 إكسسوارات</div>
                    <div class="stall-actions">
                        <button class="btn btn-primary">تسوق الآن</button>
                        <button class="btn btn-secondary">كتالوج الأزياء</button>
                    </div>
                </article>

                <article class="stall-card" onclick="openStall('riyadh-crafts')" role="button" tabindex="0">
                    <header class="stall-header">
                        <h3 class="stall-name">حرف الرياض التراثية</h3>
                        <div class="stall-rating" aria-label="Rating 4.9 out of 5">⭐ ٤.٩</div>
                    </header>
                    <p class="stall-description">
                        حرف يدوية تراثية وهدايا فريدة من التراث العربي الأصيل
                        <br><small>Traditional handicrafts and unique gifts from Arab heritage</small>
                    </p>
                    <div class="stall-products">🏺 خزف • 🗡️ خناجر تراثية • 🎨 لوحات فنية</div>
                    <div class="stall-actions">
                        <button class="btn btn-primary">استكشف الحرف</button>
                        <button class="btn btn-secondary">طلب مخصص</button>
                    </div>
                </article>
            </div>
        </section>

        <section class="marketplace-section">
            <h2 class="section-title">مميزات السوق - Platform Features</h2>
            <div class="features">
                <div class="feature-card">
                    <div class="feature-icon">🔒</div>
                    <h3 class="feature-title">أمان مطلق</h3>
                    <p class="feature-description">
                        مدفوعات آمنة بالبيتكوين وشبكة البرق مع ضمان حماية البيانات الشخصية
                    </p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">⚡</div>
                    <h3 class="feature-title">مدفوعات فورية</h3>
                    <p class="feature-description">
                        معاملات سريعة ورسوم منخفضة باستخدام شبكة البرق البيتكوين
                    </p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">🌐</div>
                    <h3 class="feature-title">لامركزي</h3>
                    <p class="feature-description">
                        لا توجد سلطة مركزية تتحكم في السوق - حرية كاملة للتجار والمشترين
                    </p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">🔐</div>
                    <h3 class="feature-title">خصوصية تامة</h3>
                    <p class="feature-description">
                        حماية الهوية والمعاملات مع إمكانية التصفح عبر تور للحماية القصوى
                    </p>
                </div>
            </div>
        </section>

        <footer class="footer">
            <h3>انضم إلى ثورة التجارة اللامركزية</h3>
            <p>بتكوين.بازار - حيث يلتقي التراث العربي بتقنية البلوك تشين الحديثة</p>
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="openModal('register')">سجل متجرك الآن</button>
                <button class="btn btn-secondary" onclick="openModal('api')">واجهة برمجة التطبيقات</button>
            </div>
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
                <p style="font-size: 0.9rem; opacity: 0.7;">
                    Built on Diagon Alley Protocol • Lightning Network Enabled • Open Source
                </p>
            </div>
        </footer>
    </div>

    <!-- Modal for Stall Details -->
    <div id="stallModal" class="modal" role="dialog" aria-labelledby="stallModalTitle" aria-hidden="true">
        <div class="modal-content">
            <span class="close" onclick="closeModal('stallModal')" aria-label="Close modal">&times;</span>
            <div id="stallContent">
                <!-- Dynamic content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Modal for Registration -->
    <div id="registerModal" class="modal" role="dialog" aria-labelledby="registerModalTitle" aria-hidden="true">
        <div class="modal-content">
            <span class="close" onclick="closeModal('registerModal')" aria-label="Close modal">&times;</span>
            <h2 id="registerModalTitle">تسجيل متجر جديد - Register New Stall</h2>
            <form id="stallRegistrationForm" novalidate>
                <div style="margin-bottom: 15px;">
                    <label for="stallName">اسم المتجر - Stall Name:</label>
                    <input 
                        type="text" 
                        id="stallName"
                        required
                        style="width: 100%; padding: 10px; margin-top: 5px; border-radius: 5px; border: 1px solid #ddd;"
                        aria-describedby="stallNameError"
                    >
                    <div id="stallNameError" class="error-message" style="display: none; color: var(--error-color); font-size: 0.9rem; margin-top: 5px;"></div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="stallDescription">الوصف - Description:</label>
                    <textarea 
                        id="stallDescription"
                        required
                        style="width: 100%; padding: 10px; margin-top: 5px; border-radius: 5px; border: 1px solid #ddd; height: 100px;"
                        aria-describedby="stallDescriptionError"
                    ></textarea>
                    <div id="stallDescriptionError" class="error-message" style="display: none; color: var(--error-color); font-size: 0.9rem; margin-top: 5px;"></div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="stallCategory">فئة المنتجات - Product Category:</label>
                    <select 
                        id="stallCategory"
                        required
                        style="width: 100%; padding: 10px; margin-top: 5px; border-radius: 5px; border: 1px solid #ddd;"
                        aria-describedby="stallCategoryError"
                    >
                        <option value="">اختر الفئة - Select Category</option>
                        <option value="electronics">إلكترونيات - Electronics</option>
                        <option value="books">كتب - Books</option>
                        <option value="fashion">أزياء - Fashion</option>
                        <option value="handicrafts">حرف يدوية - Handicrafts</option>
                        <option value="food">أطعمة - Food</option>
                        <option value="services">خدمات - Services</option>
                        <option value="others">أخرى - Others</option>
                    </select>
                    <div id="stallCategoryError" class="error-message" style="display: none; color: var(--error-color); font-size: 0.9rem; margin-top: 5px;"></div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="stallContact">معلومات التواصل - Contact Information:</label>
                    <input 
                        type="email" 
                        id="stallContact"
                        required
                        placeholder="your@email.com"
                        style="width: 100%; padding: 10px; margin-top: 5px; border-radius: 5px; border: 1px solid #ddd;"
                        aria-describedby="stallContactError"
                    >
                    <div id="stallContactError" class="error-message" style="display: none; color: var(--error-color); font-size: 0.9rem; margin-top: 5px;"></div>
                </div>
                <div style="margin-bottom: 20px;">
                    <label>
                        <input type="checkbox" id="agreeTerms" required>
                        أوافق على الشروط والأحكام - I agree to the terms and conditions
                    </label>
                    <div id="agreeTermsError" class="error-message" style="display: none; color: var(--error-color); font-size: 0.9rem; margin-top: 5px;"></div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">إنشاء المتجر - Create Stall</button>
            </form>
        </div>
    </div>

    <!-- API Modal -->
    <div id="apiModal" class="modal" role="dialog" aria-labelledby="apiModalTitle" aria-hidden="true">
        <div class="modal-content">
            <span class="close" onclick="closeModal('apiModal')" aria-label="Close modal">&times;</span>
            <h2 id="apiModalTitle">API Documentation</h2>
            <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin: 20px 0;">
                <h3>Stall Endpoints:</h3>
                <div style="font-family: monospace; background: #333; color: #0f0; padding: 15px; border-radius: 5px; margin: 10px 0;">
                    <div>GET /products/&lt;indexer_ID&gt;</div>
                    <div>POST /order/&lt;indexer_ID&gt;</div>
                    <div>GET /status/&lt;checking_id&gt;</div>
                </div>
                
                <h3 style="margin-top: 20px;">Indexer Endpoints:</h3>
                <div style="font-family: monospace; background: #333; color: #0f0; padding: 15px; border-radius: 5px; margin: 10px 0;">
                    <div>POST /register/&lt;stall_ID&gt;</div>
                </div>

                <h3 style="margin-top: 20px;">Example Response:</h3>
                <pre style="background: #333; color: #0f0; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 0.9rem;">
{
  "products": [
    {
      "product_id": "abc123",
      "product_name": "هاتف ذكي",
      "categories": ["electronics"],
      "description": "أحدث الهواتف الذكية",
      "image": "phone.jpg",
      "price": 500000,
      "quantity": 10
    }
  ]
}</pre>
            </div>
            <p>Based on the <a href="https://github.com/lnbits/Diagon-Alley" target="_blank" rel="noopener">Diagon Alley protocol</a> for decentralized marketplace architecture.</p>
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="copyApiCode()">Copy Example Code</button>
                <button class="btn btn-secondary" onclick="window.open('https://github.com/lnbits/Diagon-Alley', '_blank')">View Full Specs</button>
            </div>
        </div>
    </div>

    <!-- Success/Error Toast -->
    <div id="toast" style="
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--success-color);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: var(--shadow-lg);
        transform: translateX(400px);
        transition: transform 0.3s ease;
        z-index: 10001;
        display: none;
    ">
        <div id="toastMessage"></div>
    </div>

    <script>
        // Performance monitoring
        const perfStart = performance.now();

        // Global state management
        const AppState = {
            isLoading: true,
            btcPrice: 67420,
            networkStatus: 'connected',
            lightningStatus: 'active',
            searchIndex: new Map(),
            stallsData: new Map()
        };

        // Sample stall data with enhanced structure
        const stallsData = {
            'dubai-electronics': {
                id: 'dubai-electronics',
                name: 'متجر دبي للإلكترونيات - Dubai Electronics',
                description: 'أحدث الأجهزة الإلكترونية والهواتف الذكية بأفضل الأسعار',
                rating: 4.9,
                location: 'Dubai, UAE',
                verified: true,
                products: [
                    { 
                        id: 'iphone15pro',
                        name: 'iPhone 15 Pro', 
                        price: '0.02 BTC', 
                        priceSat: 2000000,
                        category: 'هواتف',
                        image: 'https://via.placeholder.com/200x200/f39c12/fff?text=📱',
                        stock: 5,
                        description: 'أحدث هاتف آيفون بتقنية متطورة'
                    },
                    { 
                        id: 'macbookpro',
                        name: 'MacBook Pro M3', 
                        price: '0.05 BTC', 
                        priceSat: 5000000,
                        category: 'أجهزة كمبيوتر',
                        image: 'https://via.placeholder.com/200x200/3498db/fff?text=💻',
                        stock: 3,
                        description: 'جهاز MacBook Pro بمعالج M3 القوي'
                    },
                    { 
                        id: 'airpodspro',
                        name: 'AirPods Pro', 
                        price: '0.005 BTC', 
                        priceSat: 500000,
                        category: 'سماعات',
                        image: 'https://via.placeholder.com/200x200/9b59b6/fff?text=🎧',
                        stock: 12,
                        description: 'سماعات لاسلكية مع إلغاء الضوضاء'
                    },
                    { 
                        id: 'ipadair',
                        name: 'iPad Air', 
                        price: '0.015 BTC', 
                        priceSat: 1500000,
                        category: 'أجهزة لوحية',
                        image: 'https://via.placeholder.com/200x200/e74c3c/fff?text=📱',
                        stock: 7,
                        description: 'جهاز iPad Air خفيف وقوي'
                    }
                ]
            },
            'cairo-books': {
                id: 'cairo-books',
                name: 'مكتبة القاهرة الرقمية - Cairo Digital Library',
                description: 'كتب ومراجع تقنية وأدبية باللغتين العربية والإنجليزية',
                rating: 4.8,
                location: 'Cairo, Egypt',
                verified: true,
                products: [
                    { 
                        id: 'bitcoin-book',
                        name: 'كتاب البيتكوين', 
                        price: '0.001 BTC', 
                        priceSat: 100000,
                        category: 'تقنية',
                        image: 'https://via.placeholder.com/200x200/f39c12/fff?text=📚',
                        stock: 50,
                        description: 'دليل شامل لفهم البيتكوين والعملات المشفرة'
                    },
                    { 
                        id: 'black-suits-you',
                        name: 'الأسود يليق بك', 
                        price: '0.0008 BTC', 
                        priceSat: 80000,
                        category: 'أدب',
                        image: 'https://via.placeholder.com/200x200/2c3e50/fff?text=📖',
                        stock: 30,
                        description: 'رواية أدبية مؤثرة للكاتب أحلام مستغانمي'
                    },
                    { 
                        id: 'programming-guide',
                        name: 'دليل البرمجة', 
                        price: '0.002 BTC', 
                        priceSat: 200000,
                        category: 'تقنية',
                        image: 'https://via.placeholder.com/200x200/27ae60/fff?text=💻',
                        stock: 25,
                        description: 'دليل شامل لتعلم البرمجة من الصفر'
                    },
                    { 
                        id: 'arab-history',
                        name: 'تاريخ العرب', 
                        price: '0.0012 BTC', 
                        priceSat: 120000,
                        category: 'تاريخ',
                        image: 'https://via.placeholder.com/200x200/d35400/fff?text=📜',
                        stock: 20,
                        description: 'تاريخ شامل للحضارة العربية'
                    }
                ]
            },
            'beirut-fashion': {
                id: 'beirut-fashion',
                name: 'بوتيك بيروت للأزياء - Beirut Fashion Boutique',
                description: 'أزياء عصرية وتقليدية للرجال والنساء بجودة عالية',
                rating: 4.7,
                location: 'Beirut, Lebanon',
                verified: true,
                products: [
                    { 
                        id: 'evening-dress',
                        name: 'فستان سهرة', 
                        price: '0.008 BTC', 
                        priceSat: 800000,
                        category: 'نسائي',
                        image: 'https://via.placeholder.com/200x200/e91e63/fff?text=👗',
                        stock: 8,
                        description: 'فستان سهرة أنيق ومميز'
                    },
                    { 
                        id: 'formal-suit',
                        name: 'بدلة رسمية', 
                        price: '0.012 BTC', 
                        priceSat: 1200000,
                        category: 'رجالي',
                        image: 'https://via.placeholder.com/200x200/34495e/fff?text=👔',
                        stock: 6,
                        description: 'بدلة رسمية عالية الجودة'
                    },
                    { 
                        id: 'handbag',
                        name: 'حقيبة يد', 
                        price: '0.004 BTC', 
                        priceSat: 400000,
                        category: 'إكسسوارات',
                        image: 'https://via.placeholder.com/200x200/8e44ad/fff?text=👜',
                        stock: 15,
                        description: 'حقيبة يد جلدية فاخرة'
                    },
                    { 
                        id: 'leather-shoes',
                        name: 'حذاء جلدي', 
                        price: '0.006 BTC', 
                        priceSat: 600000,
                        category: 'أحذية',
                        image: 'https://via.placeholder.com/200x200/795548/fff?text=👞',
                        stock: 10,
                        description: 'حذاء جلدي إيطالي فاخر'
                    }
                ]
            },
            'riyadh-crafts': {
                id: 'riyadh-crafts',
                name: 'حرف الرياض التراثية - Riyadh Traditional Crafts',
                description: 'حرف يدوية تراثية وهدايا فريدة من التراث العربي الأصيل',
                rating: 4.9,
                location: 'Riyadh, Saudi Arabia',
                verified: true,
                products: [
                    { 
                        id: 'omani-dagger',
                        name: 'خنجر عماني', 
                        price: '0.015 BTC', 
                        priceSat: 1500000,
                        category: 'تراث',
                        image: 'https://via.placeholder.com/200x200/c0392b/fff?text=🗡️',
                        stock: 3,
                        description: 'خنجر عماني تراثي أصيل مصنوع يدوياً'
                    },
                    { 
                        id: 'copper-pot',
                        name: 'إبريق نحاسي', 
                        price: '0.01 BTC', 
                        priceSat: 1000000,
                        category: 'أواني',
                        image: 'https://via.placeholder.com/200x200/d68910/fff?text=🏺',
                        stock: 5,
                        description: 'إبريق نحاسي مزخرف بالطريقة التقليدية'
                    },
                    { 
                        id: 'arabic-calligraphy',
                        name: 'لوحة خط عربي', 
                        price: '0.02 BTC', 
                        priceSat: 2000000,
                        category: 'فنون',
                        image: 'https://via.placeholder.com/200x200/148f77/fff?text=🎨',
                        stock: 7,
                        description: 'لوحة خط عربي مكتوبة بخط الثلث'
                    },
                    { 
                        id: 'handwoven-carpet',
                        name: 'سجادة يدوية', 
                        price: '0.025 BTC', 
                        priceSat: 2500000,
                        category: 'منسوجات',
                        image: 'https://via.placeholder.com/200x200/a04000/fff?text=🧶',
                        stock: 2,
                        description: 'سجادة منسوجة يدوياً بأنماط تراثية'
                    }
                ]
            }
        };

        // Initialize search index
        function buildSearchIndex() {
            AppState.searchIndex.clear();
            Object.values(stallsData).forEach(stall => {
                // Index stall names and descriptions
                const stallText = `${stall.name} ${stall.description}`.toLowerCase();
                AppState.searchIndex.set(stall.id, {
                    type: 'stall',
                    data: stall,
                    searchText: stallText
                });

                // Index products
                stall.products.forEach(product => {
                    const productText = `${product.name} ${product.description} ${product.category}`.toLowerCase();
                    AppState.searchIndex.set(`${stall.id}-${product.id}`, {
                        type: 'product',
                        data: { ...product, stallId: stall.id, stallName: stall.name },
                        searchText: productText
                    });
                });
            });
        }

        // Enhanced search functionality
        function performSearch(query) {
            if (!query.trim()) return [];
            
            const searchTerm = query.toLowerCase();
            const results = [];

            AppState.searchIndex.forEach((item, key) => {
                if (item.searchText.includes(searchTerm)) {
                    results.push({
                        ...item,
                        relevance: calculateRelevance(item.searchText, searchTerm)
                    });
                }
            });

            return results.sort((a, b) => b.relevance - a.relevance).slice(0, 10);
        }

        function calculateRelevance(text, searchTerm) {
            const exactMatch = text.includes(searchTerm) ? 10 : 0;
            const wordMatch = searchTerm.split(' ').reduce((score, word) => {
                return score + (text.includes(word) ? 5 : 0);
            }, 0);
            return exactMatch + wordMatch;
        }

        // Modal management
        function openStall(stallId) {
            const stall = stallsData[stallId];
            if (!stall) {
                showToast('متجر غير موجود - Stall not found', 'error');
                return;
            }

            const content = `
                <h2 id="stallModalTitle">${stall.name}</h2>
                <div style="margin-bottom: 20px;">
                    <span style="background: var(--success-color); color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">
                        ${stall.verified ? '✓ متحقق منه' : 'غير متحقق'}
                    </span>
                    <span style="margin-left: 10px; color: var(--text-secondary);">
                        📍 ${stall.location}
                    </span>
                    <span style="margin-left: 10px;">
                        ⭐ ${stall.rating}/5
                    </span>
                </div>
                <p style="margin-bottom: 20px; color: var(--text-secondary);">${stall.description}</p>
                <div class="product-grid">
                    ${stall.products.map(product => `
                        <div class="product-card" id="product-${product.id}">
                            <img src="${product.image}" alt="${product.name}" style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 10px;">
                            <h4 style="margin-bottom: 8px;">${product.name}</h4>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 8px;">${product.description}</p>
                            <p style="font-weight: bold; color: var(--primary-color);">السعر: ${product.price}</p>
                            <p style="font-size: 0.8rem; color: var(--text-secondary);">المخزون: ${product.stock}</p>
                            <p style="font-size: 0.8rem; color: var(--text-secondary);">الفئة: ${product.category}</p>
                            <button 
                                class="btn btn-primary" 
                                style="width: 100%; margin-top: 10px;" 
                                onclick="buyProduct('${product.id}', '${product.name}', '${product.price}', ${product.priceSat})"
                                ${product.stock === 0 ? 'disabled' : ''}
                            >
                                ${product.stock === 0 ? 'نفد المخزون' : 'اشتري الآن ⚡'}
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;

            document.getElementById('stallContent').innerHTML = content;
            document.getElementById('stallModal').style.display = 'block';
            document.getElementById('stallModal').setAttribute('aria-hidden', 'false');
        }

        async function buyProduct(productId, productName, price, priceSat) {
            try {
                showLoadingToast('جاري إنشاء فاتورة البرق...');

                // Simulate Lightning invoice generation
                const invoice = await processLightningPayment(priceSat, productName);
                
                hideToast();

                // Show invoice modal
                showInvoiceModal(invoice, productName, price);

            } catch (error) {
                console.error('Error generating invoice:', error);
                showToast('خطأ في إنشاء الفاتورة - Error generating invoice', 'error');
            }
        }

        function showInvoiceModal(invoice, productName, price) {
            const invoiceModal = document.createElement('div');
            invoiceModal.className = 'modal';
            invoiceModal.style.display = 'block';
            invoiceModal.setAttribute('aria-hidden', 'false');
            invoiceModal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="this.parentElement.parentElement.remove(); this.parentElement.parentElement.setAttribute('aria-hidden', 'true')" aria-label="Close invoice modal">&times;</span>
                    <h2>فاتورة البرق - Lightning Invoice</h2>
                    <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div>
                                <strong>المنتج - Product:</strong><br>
                                ${productName}
                            </div>
                            <div>
                                <strong>السعر - Price:</strong><br>
                                ${price} (${invoice.amount_sat.toLocaleString()} sats)
                            </div>
                            <div>
                                <strong>انتهاء الصلاحية - Expires:</strong><br>
                                ${new Date(invoice.expires_at).toLocaleString('ar-EG')}
                            </div>
                            <div>
                                <strong>معرف الدفع - Payment Hash:</strong><br>
                                <code style="font-size: 0.8rem; word-break: break-all;">${invoice.payment_hash}</code>
                            </div>
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <label><strong>Payment Request:</strong></label>
                            <div style="position: relative;">
                                <textarea 
                                    readonly 
                                    id="invoiceText-${invoice.payment_hash}"
                                    style="width: 100%; height: 100px; font-family: monospace; font-size: 0.8rem; padding: 10px; border-radius: 5px; border: 1px solid #ddd; resize: vertical;"
                                >${invoice.payment_request}</textarea>
                                <button 
                                    class="btn btn-secondary" 
                                    style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; font-size: 0.8rem;"
                                    onclick="copyToClipboard('invoiceText-${invoice.payment_hash}')"
                                >
                                    نسخ
                                </button>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin: 20px 0;">
                            <div style="background: white; padding: 20px; display: inline-block; border-radius: 10px; box-shadow: var(--shadow-md);">
                                <div id="qrcode-${invoice.payment_hash}" style="margin-bottom: 10px;"></div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">
                                    امسح بمحفظة البرق<br>
                                    Scan with Lightning Wallet
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 12px; height: 12px; background: var(--warning-color); border-radius: 50%; animation: pulse 2s infinite;"></div>
                                <strong>في انتظار الدفع - Waiting for Payment</strong>
                            </div>
                            <div style="font-size: 0.9rem; margin-top: 5px; color: var(--text-secondary);">
                                يرجى دفع الفاتورة خلال الوقت المحدد
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="simulatePayment('${invoice.payment_hash}', '${productName}')">
                            محاكاة الدفع - Simulate Payment
                        </button>
                        <button class="btn btn-secondary" onclick="checkPaymentStatus('${invoice.payment_hash}')">
                            تحقق من الحالة - Check Status
                        </button>
                        <button class="btn" style="background: var(--text-secondary);" onclick="this.closest('.modal').remove()">
                            إلغاء - Cancel
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(invoiceModal);

            // Generate QR code (simplified representation)
            generateQRCode(`qrcode-${invoice.payment_hash}`, invoice.payment_request);

            // Auto-check payment status every 5 seconds
            const statusInterval = setInterval(() => {
                if (!document.getElementById(`qrcode-${invoice.payment_hash}`)) {
                    clearInterval(statusInterval);
                    return;
                }
                // In real implementation, this would check actual payment status
            }, 5000);
        }

        function generateQRCode(elementId, text) {
            // Simplified QR code representation
            const qrElement = document.getElementById(elementId);
            if (qrElement) {
                qrElement.innerHTML = `
                    <div style="
                        width: 150px; 
                        height: 150px; 
                        background: white; 
                        border: 2px solid #333; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        font-size: 2rem;
                        border-radius: 8px;
                    ">
                        📱<br>
                        <div style="font-size: 0.7rem; margin-top: 5px;">QR Code</div>
                    </div>
                `;
            }
        }

        async function simulatePayment(paymentHash, productName) {
            showLoadingToast('جاري معالجة الدفع...');
            
            // Simulate payment processing delay
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            hideToast();
            showToast(`تم الدفع بنجاح! ✅\nPayment Successful!\n\nHash: ${paymentHash.slice(0, 8)}...\n\nسيتم شحن "${productName}" خلال 2-3 أيام عمل`, 'success');
            
            // Close all modals
            document.querySelectorAll('.modal').forEach(modal => modal.remove());
            
            // Update product stock (simulation)
            updateProductStock(productName);
        }

        function updateProductStock(productName) {
            // Find and update product stock
            Object.values(stallsData).forEach(stall => {
                const product = stall.products.find(p => p.name === productName);
                if (product && product.stock > 0) {
                    product.stock--;
                }
            });
        }

        async function checkPaymentStatus(paymentHash) {
            showLoadingToast('جاري التحقق من حالة الدفع...');
            
            // Simulate API call delay
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            hideToast();
            
            // Simulate random status
            const statuses = ['PENDING', 'PAID', 'EXPIRED'];
            const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
            
            const statusMessages = {
                'PENDING': 'في الانتظار - Payment Pending',
                'PAID': 'تم الدفع - Payment Confirmed',
                'EXPIRED': 'انتهت الصلاحية - Payment Expired'
            };
            
            showToast(statusMessages[randomStatus] || 'حالة غير معروفة - Unknown Status', 
                     randomStatus === 'PAID' ? 'success' : 'warning');
        }

        async function processLightningPayment(amountSat, description) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    const invoice = {
                        payment_request: `lnbc${amountSat}u1p${Math.random().toString(36).substr(2, 20)}${Math.random().toString(36).substr(2, 20)}`,
                        payment_hash: Math.random().toString(36).substr(2, 32),
                        expires_at: Date.now() + 3600000, // 1 hour from now
                        description: description,
                        amount_sat: amountSat
                    };
                    resolve(invoice);
                }, 1500);
            });
        }

        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.select();
                element.setSelectionRange(0, 99999);
                
                try {
                    document.execCommand('copy');
                    showToast('تم النسخ - Copied to clipboard!', 'success');
                } catch (err) {
                    // Fallback for modern browsers
                    navigator.clipboard.writeText(element.value).then(() => {
                        showToast('تم النسخ - Copied to clipboard!', 'success');
                    }).catch(() => {
                        showToast('فشل النسخ - Copy failed', 'error');
                    });
                }
            }
        }

        function copyApiCode() {
            const apiCode = `
// Diagon Alley API Integration Example
const stallAPI = {
    baseURL: 'https://your-stall-api.com',
    
    async getProducts(indexerId) {
        const response = await fetch(\`\${this.baseURL}/products/\${indexerId}\`);
        return response.json();
    },
    
    async createOrder(indexerId, orderData) {
        const response = await fetch(\`\${this.baseURL}/order/\${indexerId}\`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(orderData)
        });
        return response.json();
    },
    
    async checkStatus(checkingId) {
        const response = await fetch(\`\${this.baseURL}/status/\${checkingId}\`);
        return response.json();
    }
};

// Usage example
stallAPI.getProducts('arabic-marketplace')
    .then(products => console.log('Products:', products))
    .catch(error => console.error('Error:', error));
`;

            navigator.clipboard.writeText(apiCode).then(() => {
                showToast('تم نسخ كود المثال - Example code copied!', 'success');
            }).catch(() => {
                showToast('فشل النسخ - Copy failed', 'error');
            });
        }

        // Modal management functions
        function openModal(modalType) {
            const modalMap = {
                'register': 'registerModal',
                'api': 'apiModal'
            };
            
            const modalId = modalMap[modalType];
            if (modalId) {
                const modal = document.getElementById(modalId);
                modal.style.display = 'block';
                modal.setAttribute('aria-hidden', 'false');
                
                // Focus management for accessibility
                const firstInput = modal.querySelector('input, button, textarea, select');
                if (firstInput) firstInput.focus();
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');
            }
        }

        // Toast notification system
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            // Set message
            toastMessage.innerHTML = message.replace(/\n/g, '<br>');
            
            // Set colors based on type
            const colors = {
                'success': 'var(--success-color)',
                'error': 'var(--error-color)',
                'warning': 'var(--warning-color)',
                'info': 'var(--primary-color)'
            };
            
            toast.style.background = colors[type] || colors.info;
            toast.style.display = 'block';
            toast.style.transform = 'translateX(0)';
            
            // Auto hide after 5 seconds
            setTimeout(() => hideToast(), 5000);
        }

        function showLoadingToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    ${message}
                </div>
            `;
            
            toast.style.background = 'var(--secondary-color)';
            toast.style.display = 'block';
            toast.style.transform = 'translateX(0)';
        }

        function hideToast() {
            const toast = document.getElementById('toast');
            toast.style.transform = 'translateX(400px)';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 300);
        }

        // Form validation and submission
        function validateForm(formId) {
            const form = document.getElementById(formId);
            const inputs = form.querySelectorAll('input[required], textarea[required], select[required]');
            let isValid = true;

            inputs.forEach(input => {
                const errorDiv = document.getElementById(input.id + 'Error');
                
                if (!input.value.trim()) {
                    if (errorDiv) {
                        errorDiv.textContent = 'هذا الحقل مطلوب - This field is required';
                        errorDiv.style.display = 'block';
                    }
                    input.style.borderColor = 'var(--error-color)';
                    isValid = false;
                } else {
                    if (errorDiv) {
                        errorDiv.style.display = 'none';
                    }
                    input.style.borderColor = '#ddd';
                    
                    // Email validation
                    if (input.type === 'email' && !isValidEmail(input.value)) {
                        if (errorDiv) {
                            errorDiv.textContent = 'يرجى إدخال بريد إلكتروني صحيح - Please enter a valid email';
                            errorDiv.style.display = 'block';
                        }
                        input.style.borderColor = 'var(--error-color)';
                        isValid = false;
                    }
                }
            });

            return isValid;
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Search functionality
        function setupSearch() {
            const searchInput = document.querySelector('.search-input');
            const searchBtn = document.querySelector('.search-btn');
            
            let searchTimeout;
            
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    if (e.target.value.trim().length > 2) {
                        performSearchUI(e.target.value);
                    }
                }, 300);
            });
            
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    performSearchUI(e.target.value);
                }
            });
            
            searchBtn.addEventListener('click', () => {
                performSearchUI(searchInput.value);
            });
        }

        function performSearchUI(query) {
            if (!query.trim()) {
                showToast('يرجى إدخال كلمة للبحث - Please enter a search term', 'warning');
                return;
            }
            
            const results = performSearch(query);
            showSearchResults(results, query);
        }

        function showSearchResults(results, query) {
            if (results.length === 0) {
                showToast(`لم يتم العثور على نتائج لـ "${query}" - No results found for "${query}"`, 'warning');
                return;
            }
            
            const searchModal = document.createElement('div');
            searchModal.className = 'modal';
            searchModal.style.display = 'block';
            searchModal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h2>نتائج البحث لـ "${query}" - Search Results for "${query}"</h2>
                    <div style="margin-top: 20px;">
                        ${results.map(result => {
                            if (result.type === 'stall') {
                                return `
                                    <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 15px; cursor: pointer;" onclick="this.closest('.modal').remove(); openStall('${result.data.id}');">
                                        <h3>${result.data.name}</h3>
                                        <p style="color: var(--text-secondary); margin-bottom: 8px;">${result.data.description}</p>
                                        <div style="display: flex; gap: 15px; font-size: 0.9rem; color: var(--text-secondary);">
                                            <span>⭐ ${result.data.rating}</span>
                                            <span>📍 ${result.data.location}</span>
                                            <span>📦 ${result.data.products.length} منتج</span>
                                        </div>
                                    </div>
                                `;
                            } else {
                                return `
                                    <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                                        <h4>${result.data.name}</h4>
                                        <p style="color: var(--text-secondary); margin-bottom: 8px;">${result.data.description}</p>
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span style="font-weight: bold; color: var(--primary-color);">${result.data.price || 'غير محدد'}</span>
                                            <span style="font-size: 0.9rem; color: var(--text-secondary);">من ${result.data.stallName}</span>
                                        </div>
                                    </div>
                                `;
                            }
                        }).join('')}
                    </div>
                </div>
            `;
            document.body.appendChild(searchModal);
        }

        // Statistics animation
        function animateStats() {
            const statNumbers = document.querySelectorAll('.stat-number[data-target]');
            
            statNumbers.forEach(stat => {
                const target = parseFloat(stat.getAttribute('data-target'));
                const increment = target / 100;
                let current = 0;
                
                const timer = setInterval(() => {
                    current += increment;
                    if (current >= target) {
                        current = target;
                        clearInterval(timer);
                    }
                    
                    if (target % 1 === 0) {
                        stat.textContent = Math.floor(current).toLocaleString('ar-EG');
                    } else {
                        stat.textContent = current.toFixed(1);
                    }
                }, 20);
            });
        }

        // Bitcoin price updates
        async function updateBitcoinPrice() {
            try {
                // In production, you would fetch from a real API
                // const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd');
                // const data = await response.json();
                // const price = data.bitcoin.usd;
                
                // Simulate price fluctuation
                const basePrice = AppState.btcPrice;
                const fluctuation = (Math.random() - 0.5) * 2000;
                const newPrice = Math.max(1000, Math.floor(basePrice + fluctuation));
                
                AppState.btcPrice = newPrice;
                const priceElement = document.getElementById('btcPrice');
                if (priceElement) {
                    priceElement.innerHTML = `
                        <div class="status-dot"></div>
                        <span>₿ ${newPrice.toLocaleString()}</span>
                    `;
                }
            } catch (error) {
                console.error('Error updating Bitcoin price:', error);
            }
        }

        // Network status updates
        function updateNetworkStatus() {
            const statuses = [
                { text: 'متصل', color: 'var(--success-color)' },
                { text: 'Online', color: 'var(--success-color)' },
                { text: 'قيد التزامن', color: 'var(--warning-color)' },
                { text: 'Syncing', color: 'var(--warning-color)' }
            ];
            
            const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
            const networkElement = document.getElementById('networkStatus');
            
            if (networkElement) {
                networkElement.innerHTML = `
                    <div class="status-dot" style="background: ${randomStatus.color};"></div>
                    <span>${randomStatus.text}</span>
                `;
            }
        }

        // Loading screen management
        function hideLoadingScreen() {
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen) {
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    AppState.isLoading = false;
                }, 500);
            }
        }

        // Initialize app
        function initializeApp() {
            console.log('🚀 Initializing Bitcoin Bazaar...');
            
            // Build search index
            buildSearchIndex();
            
            // Setup event listeners
            setupSearch();
            
            // Setup form validation
            document.getElementById('stallRegistrationForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (validateForm('stallRegistrationForm')) {
                    showLoadingToast('جاري إرسال طلب التسجيل...');
                    
                    // Simulate form submission
                    setTimeout(() => {
                        hideToast();
                        showToast('تم إرسال طلب التسجيل بنجاح!\nRequest submitted successfully!\n\nسيتم مراجعة متجرك وإضافته خلال 24 ساعة.', 'success');
                        closeModal('registerModal');
                        
                        // Reset form
                        document.getElementById('stallRegistrationForm').reset();
                    }, 2000);
                }
            });
            
            // Setup modal closing on outside click
            window.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                    event.target.setAttribute('aria-hidden', 'true');
                }
            });
            
            // Setup keyboard navigation
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const visibleModals = document.querySelectorAll('.modal[style*="block"]');
                    visibleModals.forEach(modal => {
                        modal.style.display = 'none';
                        modal.setAttribute('aria-hidden', 'true');
                    });
                }
            });
            
            // Start periodic updates
            setInterval(updateBitcoinPrice, 30000); // Every 30 seconds
            setInterval(updateNetworkStatus, 45000); // Every 45 seconds
            
            // Animate statistics
            setTimeout(animateStats, 1000);
            
            // Hide loading screen
            setTimeout(hideLoadingScreen, 2000);
            
            // Performance monitoring
            const perfEnd = performance.now();
            console.log(`⚡ App initialized in ${Math.round(perfEnd - perfStart)}ms`);
            
            // Show welcome message
            setTimeout(() => {
                showToast('مرحباً ببتكوين.بازار! 🎉\nWelcome to Bitcoin Bazaar!', 'success');
            }, 3000);
        }

        // Start the app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        // Service worker registration for PWA capabilities
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // Add to the global scope for debugging
        window.BitcoinBazaar = {
            AppState,
            stallsData,
            openStall,
            performSearch,
            updateBitcoinPrice,
            version: '1.0.0'
        };
    </script>
</body>
</html>
                